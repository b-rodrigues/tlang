name: Pipeline Integration Test

on:
  push:
    branches: [ main, develop, pipeline ]
  pull_request:
    branches: [ main, develop ]

jobs:
  pipeline-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Nix
      uses: cachix/install-nix-action@v24
      with:
        nix_path: nixpkgs=channel:nixos-unstable
        extra_nix_config: |
          experimental-features = nix-command flakes
          substituters = https://cache.nixos.org https://rstats-on-nix.cachix.org
          trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= rstats-on-nix.cachix.org-1:vdiiVgocg6WeJrODIqdprZRUrhi1JzhBnXv7aWI6+F0=

    - name: Setup Cachix
      uses: cachix/cachix-action@v13
      with:
        name: rstats-on-nix
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
        skipPush: true

    - name: Build T
      run: nix develop --command dune build

    - name: Download mtcars data
      run: |
        mkdir -p data
        wget -q -O data/mtcars.csv \
          https://raw.githubusercontent.com/b-rodrigues/rixpress_demos/refs/heads/master/basic_r/data/mtcars.csv

    - name: Create env.nix for pipeline sandbox
      run: |
        # Make the locally built T binary available inside nix-build sandboxes
        T_BIN=$(nix develop --command which t 2>/dev/null || echo "")
        if [ -z "$T_BIN" ]; then
          # Fallback: build from flake and use that path
          T_STORE=$(nix build .# --no-link --print-out-paths 2>/dev/null || echo "")
          cat > env.nix << 'ENVEOF'
        { pkgs ? import <nixpkgs> {} }:
        {
          buildInputs = [];
        }
        ENVEOF
        else
          T_STORE=$(dirname $(dirname "$T_BIN"))
          cat > env.nix << ENVEOF
        { pkgs ? import <nixpkgs> {} }:
        let
          t-lang = builtins.storePath "$T_STORE";
        in
        {
          buildInputs = [ t-lang ];
        }
        ENVEOF
        fi

    - name: Run pipeline build
      run: |
        nix develop --command ./_build/default/src/repl.exe run tests/pipeline/test_pipeline_e2e.t

    - name: Verify pipeline artifacts
      run: |
        echo "=== _pipeline/ contents ==="
        ls -la _pipeline/
        echo ""
        echo "=== dag.json ==="
        cat _pipeline/dag.json
        echo ""
        echo "=== Build logs ==="
        ls _pipeline/build_log_* 2>/dev/null || echo "No build logs found"
        echo ""
        echo "=== Running verification script ==="
        nix develop --command ./_build/default/src/repl.exe run tests/pipeline/verify_pipeline_e2e.t --unsafe

    - name: Upload pipeline artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pipeline-artifacts
        path: _pipeline/
        retention-days: 7
